<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Login - Jellyfin Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .login-card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
    .btn-primary { background-color: #007bff; border: none; }
    .btn-primary:hover { background-color: #0056b3; }
    .error-message { color: #dc3545; font-size: 0.875rem; display: none; margin-bottom: 15px; }
  </style>
</head>
<body>

<div class="login-card">
  <div class="text-center mb-4">
    <h2 class="fw-bold">Jellyfin Manager</h2>
    <p class="text-muted">Sign in to manage user expiry</p>
  </div>

  <div id="errorAlert" class="alert alert-danger error-message" role="alert">
    Invalid username or password.
  </div>

  <form id="loginForm">
    <div class="mb-3">
      <label for="username" class="form-label">Username</label>
      <input type="text" class="form-control" id="username" required autofocus>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" id="password" required>
    </div>
    <button type="submit" id="loginBtn" class="btn btn-primary w-100 py-2 mt-2">
      <span id="btnText">Login</span>
      <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
    </button>
  </form>
</div>

<script>
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorAlert = document.getElementById('errorAlert');
      const loginBtn = document.getElementById('loginBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');

      // UI Loading State
      errorAlert.style.display = 'none';
      loginBtn.disabled = true;
      btnText.textContent = 'Authenticating...';
      btnSpinner.classList.remove('d-none');

      try {
          const response = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
          });

          if (response.ok) {
              const data = await response.json();
              // Store JWT in cookie for server-side authentication
              document.cookie = `jwt_token=${data.token}; path=/; max-age=3600`;
              // Redirect to homepage
              window.location.href = '/';
          } else {
              errorAlert.style.display = 'block';
          }
      } catch (error) {
          console.error('Error:', error);
          errorAlert.textContent = 'Connection error. Please try again.';
          errorAlert.style.display = 'block';
      } finally {
          loginBtn.disabled = false;
          btnText.textContent = 'Login';
          btnSpinner.classList.add('d-none');
      }
  });
</script>

</body>
</html>