<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Login - Jellyfin Manager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #e0e0e0;
      --text-muted: #a0a0a0;
      --border-color: #444;
      --input-bg: #3d3d3d;
    }

    body.light-mode {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --text-primary: #212529;
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --input-bg: #ffffff;
    }

    body { background-color: var(--bg-primary); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
    .login-card { background: var(--bg-secondary); padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 100%; max-width: 400px; border: 1px solid var(--border-color); }
    .login-card h2 { color: var(--text-primary); }
    .login-card .text-muted { color: var(--text-muted) !important; }
    .login-card .form-label { color: var(--text-primary); }
    .login-card .form-control { background-color: var(--input-bg); color: var(--text-primary); border-color: var(--border-color); }
    .login-card .form-control:focus { background-color: var(--input-bg); color: var(--text-primary); border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
    .btn-primary { background-color: #007bff; border: none; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-primary:disabled { background-color: #555; }
    .error-message { color: #ff6b6b; font-size: 0.875rem; display: none; margin-bottom: 15px; }
    .alert-danger { background-color: #3d2a2a; border-color: #555; color: #ff6b6b; }
    body.light-mode .alert-danger { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    .theme-toggle:hover { background: var(--border-color); }
    .toggle-icon { display: inline-block; width: 20px; height: 20px; }
  </style>
</head>
<body>

<button class="theme-toggle" id="themeToggle" title="Toggle dark/light mode">
  <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
</button>

<div class="login-card">
  <div class="text-center mb-4">
    <h2 class="fw-bold">Jellyfin Manager</h2>
    <p class="text-muted">Sign in to manage user expiry</p>
  </div>

  <div id="errorAlert" class="alert alert-danger error-message" role="alert">
    Invalid username or password.
  </div>

  <form id="loginForm">
    <div class="mb-3">
      <label for="username" class="form-label">Username</label>
      <input type="text" class="form-control" id="username" required autofocus>
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" id="password" required>
    </div>
    <button type="submit" id="loginBtn" class="btn btn-primary w-100 py-2 mt-2">
      <span id="btnText">Login</span>
      <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
    </button>
  </form>
</div>

<script>
  // Theme Toggle
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;
  const theme = localStorage.getItem('theme') || 'dark';
  
  const sunIcon = `<svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
  const moonIcon = `<svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
  
  if (theme === 'light') {
    body.classList.add('light-mode');
    themeToggle.innerHTML = sunIcon;
  } else {
    themeToggle.innerHTML = moonIcon;
  }

  themeToggle.addEventListener('click', () => {
    body.classList.toggle('light-mode');
    const newTheme = body.classList.contains('light-mode') ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    themeToggle.innerHTML = newTheme === 'light' ? sunIcon : moonIcon;
  });

  // Login Form
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorAlert = document.getElementById('errorAlert');
      const loginBtn = document.getElementById('loginBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');

      // UI Loading State
      errorAlert.style.display = 'none';
      loginBtn.disabled = true;
      btnText.textContent = 'Authenticating...';
      btnSpinner.classList.remove('d-none');

      try {
          const response = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
          });

          if (response.ok) {
              const data = await response.json();
              // Store JWT in cookie for server-side authentication
              document.cookie = `jwt_token=${data.token}; path=/; max-age=86400`;
              // Redirect to homepage
              window.location.href = '/';
          } else {
              errorAlert.style.display = 'block';
          }
      } catch (error) {
          console.error('Error:', error);
          errorAlert.textContent = 'Connection error. Please try again.';
          errorAlert.style.display = 'block';
      } finally {
          loginBtn.disabled = false;
          btnText.textContent = 'Login';
          btnSpinner.classList.add('d-none');
      }
  });
</script>

</body>
</html>